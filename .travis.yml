---
language: 'python'
python: '2.7'

notifications:
  email:
  recipients:
    - krejci@palantir.net
  on_success: change
  on_failure: always

env:
  - SITE_AND_INVENTORY='tests/test.yml -i tests/inventory'

install:
  - 'pip install ansible==1.8.2'
  - 'printf "[defaults]\nroles_path = provisioning/roles/" > ansible.cfg'
  - 'sudo rm -Rf $(which node)'
  - 'sudo rm -Rf $(which npm)'

script:
  - 'ansible-playbook $SITE_AND_INVENTORY --syntax-check'
  - 'travis_wait ansible-playbook $SITE_AND_INVENTORY --connection=local -vvvv'
  - >
    ansible-playbook $SITE_AND_INVENTORY --connection=local
    | grep -q 'failed=0'
    && (echo 'Failure test: pass' && exit 0)
    || (echo 'Failure test: fail' && exit 1)
  - >
    cat /etc/hostname
    | grep -q 'travis'
    && (echo 'Hostname test: pass' && exit 0)
    || (echo 'Hostname test: fail' && exit 1)
  - >
    php -v
    | grep -q 'PHP\s5.5'
    && (echo 'PHP 5.5 test: pass' && exit 0)
    || (echo 'PHP 5.5 test: fail' && exit 1)
  - >
    apache2 -v
    | grep -q 'Apache/2.4.12'
    && (echo 'Apache2 test: pass' && exit 0)
    || (echo 'Apache2 test: fail' && exit 1)
  - >
    node --version
    | grep -q 'v0.12.0'
    && (echo 'Node version v0.12.0 test: pass' && exit 0)
    || (echo 'Node version v0.12.0 test: fail' && exit 1)
  - >
    npm --version
    | grep -q '2.5.1'
    && (echo 'npm version 2.5.1 test: pass' && exit 0)
    || (echo 'npm version 2.5.1 test: fail' && exit 1)
  - >
    pidof apache2
    && (echo 'Apache2 running test: pass' && exit 0)
    || (echo 'Apache2 running test: fail' && exit 1)
  - >
    which composer
    && (echo 'Installed composer: pass' && exit 0)
    || (echo 'Installed composer: fail' && exit 1)
  - >
    ls ~/.rvm/rubies
    | grep -q 'ruby-2.1.3'
    && (echo 'Installed rubies test: pass' && exit 0)
    || (echo 'Installed rubies test: fail' && exit 1)
  - >
    which firefox
    && (echo 'Installed iceweasel: pass' && exit 0)
    || (echo 'Installed iceweasel: fail' && exit 1)
  - >
    ls /opt
    | grep -q 'phantomjs'
    && (echo 'Installed phantomjs: pass' && exit 0)
    || (echo 'Installed phantomjs: fail' && exit 1)
  - >
    dpkg --get-selections
    | grep -q 'php5-mcrypt'
    && (echo 'php5-mcrypt test: pass' && exit 0)
    || (echo 'php5-mcrypt test: fail' && exit 1)
  - >
    dpkg --get-selections
    | grep -q 'php5-mysql'
    && (echo 'php5-mysql test: pass' && exit 0)
    || (echo 'php5-mysql test: fail' && exit 1)
  - >
    dpkg --get-selections
    | grep -q 'php5-xdebug'
    && (echo 'php5-xdebug test: pass' && exit 0)
    || (echo 'php5-xdebug test: fail' && exit 1)
  - >
    dpkg --get-selections
    | grep -q 'php5-gd'
    && (echo 'php5-gd test: pass' && exit 0)
    || (echo 'php5-gd test: fail' && exit 1)
  - >
    dpkg --get-selections
    | grep -q 'php5-curl'
    && (echo 'php5-curl test: pass' && exit 0)
    || (echo 'php5-curl test: fail' && exit 1)
  - >
    dpkg --get-selections
    | grep -q 'git'
    && (echo 'git test: pass' && exit 0)
    || (echo 'git test: fail' && exit 1)
  - >
    dpkg --get-selections
    | grep -q 'vim'
    && (echo 'vim test: pass' && exit 0)
    || (echo 'vim test: fail' && exit 1)
  - >
    dpkg --get-selections
    | grep -q 'sendmail'
    && (echo 'sendmail test: pass' && exit 0)
    || (echo 'sendmail test: fail' && exit 1)
  - >
    dpkg --get-selections
    | grep -q 'drush'
    && (echo 'drush test: pass' && exit 0)
    || (echo 'drush test: fail' && exit 1)
